@page "/chainsharp/data/dead-letters"
@inherits PollingComponentBase
@inject IDataContextProviderFactory DataContextFactory
@inject NavigationManager Navigation

<RadzenText TextStyle="TextStyle.H4" class="rz-mb-2">Dead Letters</RadzenText>
<RadzenText TextStyle="TextStyle.Body2" class="rz-mb-4" Style="color: var(--rz-text-secondary-color);">
    Workflow executions that exceeded their maximum retry count and require manual intervention. Resolve by retrying or acknowledging.
</RadzenText>

<ChainSharpDataGrid Data="@_items"
                    TItem="DeadLetter"
                    IsLoading="@IsLoading">
    <Columns>
        <RadzenDataGridColumn TItem="DeadLetter"
                              Title=""
                              Width="50px"
                              Sortable="false"
                              Filterable="false"
                              Frozen="true"
                              TextAlign="TextAlign.Center">
            <Template Context="d">
                <RadzenButton Icon="visibility"
                              Variant="Variant.Text"
                              Size="ButtonSize.Small"
                              Click="@(() => Navigation.NavigateTo($"chainsharp/data/dead-letters/{d.Id}"))" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="Id"
                              Title="Id"
                              Width="80px"
                              SortOrder="SortOrder.Descending" />
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="ManifestId"
                              Title="Manifest Id"
                              Width="140px" />
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="Status"
                              Title="Status"
                              Width="150px">
            <Template Context="d">
                <RadzenBadge BadgeStyle="@GetDeadLetterStatusBadgeStyle(d.Status)"
                             Text="@d.Status.ToString()" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="DeadLetteredAt"
                              Title="Dead Lettered At"
                              Width="200px"
                              FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="Reason"
                              Title="Reason"
                              Width="300px" />
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="RetryCountAtDeadLetter"
                              Title="Retry Count"
                              Width="140px" />
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="ResolvedAt"
                              Title="Resolved At"
                              Width="180px"
                              FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
        <RadzenDataGridColumn TItem="DeadLetter"
                              Property="ResolutionNote"
                              Title="Resolution Note"
                              Width="250px" />
    </Columns>
</ChainSharpDataGrid>

@code {
    private List<DeadLetter> _items = [];

    protected override async Task LoadDataAsync(CancellationToken cancellationToken)
    {
        using var context = await DataContextFactory.CreateDbContextAsync(cancellationToken);
        _items = await context.DeadLetters.AsNoTracking().ToListAsync(cancellationToken);
    }
}
