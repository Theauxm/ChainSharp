@page "/chainsharp/data/manifest-groups/{ManifestGroupId:int}"
@inherits PollingComponentBase

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-mb-4">
    <RadzenButton Icon="arrow_back"
                  Variant="Variant.Text"
                  Click="@(() => Navigation.NavigateTo("chainsharp/data/manifest-groups"))" />
    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0;">
        @if (_group is not null)
        {
            @_group.Name
        }
        else if (!IsLoading)
        {
            <text>Group Not Found</text>
        }
    </RadzenText>
</RadzenStack>

@if (IsLoading)
{
    <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
    return;
}

@if (_group is null)
{
    <RadzenText TextStyle="TextStyle.Body1">No manifest group found with ID @ManifestGroupId.</RadzenText>
    return;
}

@* ── Group Settings ── *@
<RadzenFieldset Text="Group Settings" class="@(IsSettingsDirty ? "cs-fieldset-dirty rz-mb-4" : "rz-mb-4")">
    <RadzenStack Gap="1.5rem">
        <RadzenStack Gap="0.25rem">
            <RadzenLabel Text="Enabled" />
            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-disabled-color);">
                When disabled, manifests in this group will not be queued or dispatched.
            </RadzenText>
            <RadzenSwitch @bind-Value="_group.IsEnabled" />
        </RadzenStack>

        <RadzenStack Gap="0.25rem">
            <RadzenLabel Text="Priority" Component="GroupPriority" />
            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-disabled-color);">
                Dispatch priority for this group (0–31). Higher values are dispatched first.
            </RadzenText>
            <RadzenNumeric @bind-Value="_group.Priority" TValue="int" Min="0" Max="31" Style="max-width: 400px;" Name="GroupPriority" />
        </RadzenStack>

        <RadzenStack Gap="0.25rem">
            <RadzenLabel Text="Max Active Jobs" Component="GroupMaxActiveJobs" />
            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-disabled-color);">
                Maximum number of concurrent active jobs for this group. Leave empty for no per-group limit.
            </RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.25rem" Style="max-width: 400px;">
                <RadzenNumeric @bind-Value="_group.MaxActiveJobs" TValue="int?" Min="1" Style="flex: 1;" Name="GroupMaxActiveJobs" />
                @if (_group.MaxActiveJobs.HasValue)
                {
                    <RadzenButton Icon="close" Variant="Variant.Text" Size="ButtonSize.Small"
                                  Click="@(() => _group.MaxActiveJobs = null)"
                                  title="Clear limit" />
                }
            </RadzenStack>
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Text="Save" Icon="save" ButtonStyle="ButtonStyle.Primary" Click="@SaveSettings" Disabled="@(!IsSettingsDirty)" />
            <RadzenButton Text="Reset" Icon="undo" ButtonStyle="ButtonStyle.Light" Click="@ResetSettings" Disabled="@(!IsSettingsDirty)" />
        </RadzenStack>
    </RadzenStack>
</RadzenFieldset>

@* ── Summary Cards ── *@
<RadzenRow Gap="1rem" class="rz-mb-4">
    <RadzenColumn Size="6" SizeMD="3">
        <RadzenCard>
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                <RadzenIcon Icon="description" Style="font-size: 2rem; color: var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0;">@_manifests.Count</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center;">Manifests</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="6" SizeMD="3">
        <RadzenCard>
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                <RadzenIcon Icon="check_circle" Style="font-size: 2rem; color: var(--rz-success);" />
                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0;">@_executions.Count(m => m.WorkflowState == WorkflowState.Completed)</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center;">Completed</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="6" SizeMD="3">
        <RadzenCard>
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                <RadzenIcon Icon="error" Style="font-size: 2rem; color: var(--rz-danger);" />
                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0;">@_executions.Count(m => m.WorkflowState == WorkflowState.Failed)</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center;">Failed</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
    <RadzenColumn Size="6" SizeMD="3">
        <RadzenCard>
            <RadzenStack AlignItems="AlignItems.Center" Gap="0.25rem">
                <RadzenIcon Icon="sync" Style="font-size: 2rem; color: var(--rz-info);" />
                <RadzenText TextStyle="TextStyle.H3" Style="margin: 0;">@_executions.Count(m => m.WorkflowState == WorkflowState.InProgress)</RadzenText>
                <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center;">In Progress</RadzenText>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@* ── Manifests in Group ── *@
<RadzenCard class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Manifests</RadzenText>
    <ChainSharpDataGrid Data="@_manifests"
                        TItem="Manifest"
                        RowClick="@OnManifestRowClick"
                        Style="cursor: pointer;">
        <Columns>
            <RadzenDataGridColumn TItem="Manifest"
                                  Property="Id"
                                  Title="Id"
                                  Width="80px"
                                  SortOrder="SortOrder.Descending" />
            <RadzenDataGridColumn TItem="Manifest"
                                  Property="Name"
                                  Title="Name"
                                  Width="250px">
                <Template Context="m">@ShortName(m.Name)</Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Manifest"
                                  Property="ExternalId"
                                  Title="External Id"
                                  Width="200px" />
            <RadzenDataGridColumn TItem="Manifest"
                                  Property="IsEnabled"
                                  Title="Enabled"
                                  Width="100px" />
            <RadzenDataGridColumn TItem="Manifest"
                                  Property="ScheduleType"
                                  Title="Schedule Type"
                                  Width="130px" />
            <RadzenDataGridColumn TItem="Manifest"
                                  Property="LastSuccessfulRun"
                                  Title="Last Successful Run"
                                  Width="180px"
                                  FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
        </Columns>
    </ChainSharpDataGrid>
</RadzenCard>

@* ── Recent Executions ── *@
<RadzenCard>
    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-2">Recent Executions</RadzenText>
    @if (_executions.Count > 0)
    {
        <ChainSharpDataGrid Data="@_executions"
                            TItem="Metadata"
                            RowClick="@OnMetadataRowClick"
                            Style="cursor: pointer;">
            <Columns>
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="Id"
                                      Title="Id"
                                      Width="80px"
                                      SortOrder="SortOrder.Descending" />
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="WorkflowState"
                                      Title="State"
                                      Width="120px">
                    <Template Context="m">
                        <RadzenBadge BadgeStyle="@GetStateBadgeStyle(m.WorkflowState)"
                                     Text="@m.WorkflowState.ToString()" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="Name"
                                      Title="Workflow"
                                      Width="200px">
                    <Template Context="m">@ShortName(m.Name)</Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="StartTime"
                                      Title="Start Time"
                                      Width="180px"
                                      FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="EndTime"
                                      Title="End Time"
                                      Width="180px"
                                      FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
                <RadzenDataGridColumn TItem="Metadata"
                                      Title="Duration"
                                      Width="120px"
                                      Sortable="false"
                                      Filterable="false">
                    <Template Context="m">@FormatDuration(m)</Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="FailureStep"
                                      Title="Failure Step"
                                      Width="150px" />
                <RadzenDataGridColumn TItem="Metadata"
                                      Property="FailureReason"
                                      Title="Failure Reason"
                                      Width="250px" />
            </Columns>
        </ChainSharpDataGrid>
    }
    else
    {
        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-disabled-color); text-align: center; padding: 2rem;">
            No executions found for this group.
        </RadzenText>
    }
</RadzenCard>
