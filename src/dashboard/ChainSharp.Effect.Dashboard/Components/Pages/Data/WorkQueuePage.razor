@page "/chainsharp/data/work-queue"
@using System.Linq.Dynamic.Core
@inherits PollingComponentBase
@inject IDataContextProviderFactory DataContextFactory
@inject NavigationManager Navigation

<RadzenText TextStyle="TextStyle.H4" class="rz-mb-2">Work Queue</RadzenText>
<RadzenText TextStyle="TextStyle.Body2" class="rz-mb-4" Style="color: var(--rz-text-secondary-color);">
    Pending and dispatched workflow execution requests. Items are queued when a manifest is due and dispatched to the task server for execution.
</RadzenText>

<ChainSharpDataGrid @ref="_grid"
                    TItem="WorkQueue"
                    ServerLoadData="@LoadPageAsync">
    <Columns>
        <RadzenDataGridColumn TItem="WorkQueue"
                              Title=""
                              Width="50px"
                              Sortable="false"
                              Filterable="false"
                              Frozen="true"
                              TextAlign="TextAlign.Center">
            <Template Context="q">
                <RadzenButton Icon="visibility"
                              Variant="Variant.Text"
                              Size="ButtonSize.Small"
                              Click="@(() => Navigation.NavigateTo($"chainsharp/data/work-queue/{q.Id}"))" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="Id"
                              Title="Id"
                              Width="80px"
                              SortOrder="SortOrder.Descending" />
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="WorkflowName"
                              Title="Workflow"
                              Width="200px">
            <Template Context="q">@ShortName(q.WorkflowName)</Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="Status"
                              Title="Status"
                              Width="120px">
            <Template Context="q">
                <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(q.Status)"
                             Text="@q.Status.ToString()" />
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="Priority"
                              Title="Priority"
                              Width="90px" />
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="ManifestId"
                              Title="Manifest Id"
                              Width="140px" />
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="MetadataId"
                              Title="Metadata Id"
                              Width="140px" />
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="CreatedAt"
                              Title="Created At"
                              Width="180px"
                              FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
        <RadzenDataGridColumn TItem="WorkQueue"
                              Property="DispatchedAt"
                              Title="Dispatched At"
                              Width="180px"
                              FormatString="{0:yyyy-MM-dd HH:mm:ss}" />
    </Columns>
</ChainSharpDataGrid>

@code {
    private ChainSharpDataGrid<WorkQueue>? _grid;

    protected override async Task LoadDataAsync(CancellationToken cancellationToken)
    {
        if (_grid is not null)
            await _grid.ReloadAsync();
    }

    private async Task<ServerDataResult<WorkQueue>> LoadPageAsync(
        LoadDataArgs args,
        CancellationToken cancellationToken)
    {
        using var context = await DataContextFactory.CreateDbContextAsync(cancellationToken);
        IQueryable<WorkQueue> query = context.WorkQueues.AsNoTracking();

        if (!string.IsNullOrEmpty(args.Filter))
            query = query.Where(args.Filter);

        if (!string.IsNullOrEmpty(args.OrderBy))
            query = query.OrderBy(args.OrderBy);
        else
            query = query.OrderByDescending(q => q.Id);

        var count = await query.CountAsync(cancellationToken);

        if (args.Skip.HasValue)
            query = query.Skip(args.Skip.Value);
        if (args.Top.HasValue)
            query = query.Take(args.Top.Value);

        var items = await query.ToListAsync(cancellationToken);
        return new ServerDataResult<WorkQueue>(items, count);
    }

    private static BadgeStyle GetStatusBadgeStyle(WorkQueueStatus status) =>
        status switch
        {
            WorkQueueStatus.Queued => BadgeStyle.Info,
            WorkQueueStatus.Dispatched => BadgeStyle.Success,
            WorkQueueStatus.Cancelled => BadgeStyle.Warning,
            _ => BadgeStyle.Light,
        };
}
